sudo: false
cache: bundler
language: ruby
services:
- memcache
- redis-server
script:
- bundle exec rake spec
- bundle exec rspec spec/ --tag js
- bundle exec rake karma:run
- bundle exec rubocop -R
before_script:
# Fail if there are any non-vendored Ruby files that include 'binding.pry'
- bash -c "! find . -type f | grep -v 'vendor/bundle' | grep -E '\.(rb|erb|rake)|(Gem|Guard|Rake)file' | xargs grep binding.pry"
- PHANTOMJS_CDNURL=https://bitbucket.org/ariya/phantomjs/downloads npm install
- psql -c 'create database mpdx_test;' -U postgres
- cp config/database.travis.yml config/database.yml
- cp config/config.travis.yml config/config.yml
- cp config/cloudinary.travis.yml config/cloudinary.yml
- bundle exec rake db:schema:load RAILS_ENV=test
branches:
  only:
  - master
  - dev
deploy:
  - provider: opsworks
    access_key_id: AKIAJYX4CH7WF7CZ2QIA
    secret_access_key:
      secure: e/dQXR+htBMkcnHNP3+N4Pz/hqGN1ke48q4f7KSvZP0qWJAM7Oii5OITmnIXxCyDl6yCM8zTVK1oPJLRQUihPs/jy9S4EW7NfkDlOatAhTqznbs5bacoPh0DsyJ+/hh/Xh8eYkp8KhLv03O5T4n858EM6PpR+zghmcL2pruKGxM=
    app-id: 36c106d9-e3c9-495c-a826-1e29854d12c7
    migrate: true
    on:
      repo: CruGlobal/mpdx
      branch: master
  - provider: opsworks
    access_key_id: AKIAJYX4CH7WF7CZ2QIA
    secret_access_key:
      secure: e/dQXR+htBMkcnHNP3+N4Pz/hqGN1ke48q4f7KSvZP0qWJAM7Oii5OITmnIXxCyDl6yCM8zTVK1oPJLRQUihPs/jy9S4EW7NfkDlOatAhTqznbs5bacoPh0DsyJ+/hh/Xh8eYkp8KhLv03O5T4n858EM6PpR+zghmcL2pruKGxM=
    app-id: 591bff4c-6d8c-4a24-b477-25715ac8a51c
    migrate: true
    on:
      repo: CruGlobal/mpdx
      branch: dev
