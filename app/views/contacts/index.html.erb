<div ng-controller="contactsController">
  <% contact_instance = Contact.new %>
  <script type="text/javascript" charset="utf-8">
      var account_contacts_json = <%= contacts_for_filter.collect { |c| {value: c.name, id: c.id} }.to_json.html_safe %>
      var filtered_contacts_ids = <%= @filtered_contacts.collect { |c| c.id }.to_json.html_safe %>
  </script>
  <div class="row">
    <div class="col-md-3 col-sm-12 hidden-sm hidden-xs mobile_filters_wrap">
      <aside id="leftmenu" class="filters_menu" data-spy="affix" data-offset-top="182" data-offset-bottom="180">
        <span class="toggle-mobile-filters close-filters hidden-lg hidden-md"><i class="fa fa-times"></i> Close Filters</span>
        <a href="#" ng-click="resetFilters()" class="btn btn-primary btn-xs btn-block btn-filter-left ng-cloak"
           ng-hide="isEmptyFilter()"
           onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Reset Filters']);">
          <i class="fa fa-undo"></i> <%= _('Reset Filters') %>
        </a>
        <ul>
          <%= render 'sidebar_tags', tags: current_account_list.contact_tags %>
          <li class="filters_section" ng-show="!insightFilterIsActive()">
            <span class="filters_title menu_item"><%= _('Filters') %></span>
            <form id="filters_form">

              <%= hidden_field_tag 'filters[tags]', tag_params %>
              <%= hidden_field_tag :per_page, params[:per_page] %>

              <ul class="filters">
                <li class="filter_set">
                  <label id="filter_status" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Status']);"><%= _('Status') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[status]', options_for_select([[_('-- All Active --'), 'active'], [_('-- All Hidden --'), 'hidden'], [_('-- None --'), 'null']] + contact_instance.assignable_statuses.collect { |s| [_(s), s] }), multiple: true, size: 5, class: 'form-control', :'ng-model' => 'contactQuery.status' %>
                  </div>
                </li>

                <li class="filter_set">
                  <label id="filter_commitment_details" class="filter_title"
                         onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Commitment Details']);">
                    <%= _('Commitment Details') %>
                  </label>
                  <div class="filter_set_inner filter_radio">
                    <label><%= _('Commitment Received') %>:</label>
                    <label>
                      <%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.pledge_received' %>
                      <%= _('-- Any --') %>
                    </label>
                    <label>
                      <%= radio_button_tag '', 'true', false, :'ng-model' => 'contactQuery.pledge_received' %>
                      <%= _('Received') %>
                    </label>
                    <label>
                      <%= radio_button_tag '', 'false', false, :'ng-model' => 'contactQuery.pledge_received' %>
                      <%= _('Not Received') %>
                    </label>
                    <label><%= _('Commitment Frequency') %>:</label>
                    <%= select_tag 'filters[pledge_frequencies]',
                                   options_for_select([[_('-- Any --'), '']] + current_account_list.contacts.pledge_frequencies.invert.to_a, current_account_list.contacts.pledge_frequencies.to_a),
                                   class: 'form-control', multiple: true, size: 5,
                                   'ng-model' => 'contactQuery.pledge_frequencies' %>
                  </div>
                </li>

                <li class="filter_set">
                  <label id="filter_newsletter" class="filter_title"
                         onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Newsletter Recipients']);">
                    <%= _('Newsletter Recipients') %>
                  </label>
                  <div class="filter_set_inner filter_radio">
                    <label><%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.newsletter' %> <%= _('-- Any --') %></label>
                    <label><%= radio_button_tag '', 'none', false, :'ng-model' => 'contactQuery.newsletter' %> <%= _('None Selected') %></label>
                    <label><%= radio_button_tag '', 'all', false, :'ng-model' => 'contactQuery.newsletter' %> <%= _('All') %></label>
                    <label>
                      <%= radio_button_tag '', 'address', false, :'ng-model' => 'contactQuery.newsletter' %>
                      <%= _('Physical') %>
                    </label>
                    <label>
                      <%= radio_button_tag '', 'email', false, :'ng-model' => 'contactQuery.newsletter' %>
                      <%= _('Email') %>
                    </label>
                  </div>
                </li>

                <li class="filter_set">
                  <label id="filter_referrer" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Referrer']);"><%= _('Referrer') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[referrer]',
                        options_for_select(
                          [[_('-- Any --'), ''], [_('-- Someone --'), '*']] +
                            current_account_list.contacts.with_referrals.order("name").collect { |c| [c.name, c.id] }
                        ),
                        multiple: true, size: 5, class: 'form-control', :'ng-model' => 'contactQuery.referrer' %>
                  </div>
                </li>
                <li class="filter_set">
                  <label id="filter_likely" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Likely To Give']);"><%= _('Likely To Give') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag '', options_for_select([[_('-- Any --'), '']] + contact_instance.assignable_likely_to_gives),
                                   multiple: true, size: 4, class: 'form-control', :'ng-model' => 'contactQuery.likely' %>
                  </div>
                </li>
                <li class="filter_set">
                  <label id="filter_type" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Type']);"><%= _('Type') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[type]', options_for_select([[_('-- Any --'), ''], [_('Person'), 'person'], [_('Company'), 'company']]),
                                   multiple: false, size: 3, class: 'form-control', :'ng-model' => 'contactQuery.type' %>
                  </div>
                </li>
                <li class="filter_set">
                  <label id="filter_contact_location" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Location']);"><%= _('Contact Location') %></label>
                  <div class="filter_set_inner">
                    <% location_filters = [
                      ['City', 'city', :cities],
                      ['State', 'state', :states],
                      ['Region', 'region', :regions],
                      ['Country', 'country', :countries],
                      ['Metro Area', 'metro_area', :metro_areas]
                    ] %>
                    <% location_filters.each do |location| %>
                      <% options = [[_('-- Any --'), '']] + current_account_list.try(location[2]).select(&:present?) %>
                      <% next if options.count <= 1 %>
                      <label><%= _(location[0]) %>:</label>
                      <%= select_tag 'filters['+location[1]+']', options_for_select(options),
                                     multiple: true, size: [5, options.count].min, class: 'form-control',
                                     :'ng-model' => 'contactQuery.'+location[1] %>
                    <% end %>
                    <label>
                      <input type="checkbox" ng-model="contactQuery.activeAddresses"> <%= _('Active addresses') %>
                    </label>
                  </div>
                </li>
                <li class="filter_set">
                  <label id="filter_contact_info" class="filter_title"
                           onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Contact Information']);">
                      <%= _('Contact Information') %></label>
                  <div class="filter_set_inner filter_radio">
                    <%= _('Email') %>
                    <label ><%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.contact_info_email' %><%= _('-- Any --') %><br/>
                      <%= radio_button_tag '', 'Yes', false, 'ng-model' => 'contactQuery.contact_info_email'  %><%= _('Yes') %><br/>
                      <%= radio_button_tag '', 'No', false, 'ng-model' => 'contactQuery.contact_info_email' %><%= _('No') %></label>
                    <%= _('Home Phone') %>
                    <label ><%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.contact_info_phone' %><%= _('-- Any --') %><br/>
                      <%= radio_button_tag '', 'Yes', false, 'ng-model' => 'contactQuery.contact_info_phone'%><%= _('Yes') %><br/>
                      <%= radio_button_tag '', 'No', false, 'ng-model' => 'contactQuery.contact_info_phone' %><%= _('No') %></label>
                    <%= _('Mobile Phone') %>
                    <label ><%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.contact_info_mobile' %><%= _('-- Any --') %><br/>
                      <%= radio_button_tag '', 'Yes', false, 'ng-model' => 'contactQuery.contact_info_mobile'  %><%= _('Yes') %><br/>
                      <%= radio_button_tag '', 'No', false, 'ng-model' => 'contactQuery.contact_info_mobile' %><%= _('No') %>
                    </label>
                    <%= _('Address') %>
                    <label ><%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.contact_info_addr' %><%= _('-- Any --') %><br/>
                      <%= radio_button_tag '', 'Yes', false, 'ng-model' => 'contactQuery.contact_info_addr'  %><%= _('Yes') %><br/>
                      <%= radio_button_tag '', 'No', false, 'ng-model' => 'contactQuery.contact_info_addr' %><%= _('No') %>
                    </label>
                       <%= _('Facebook Profile') %>
                    <label><%= radio_button_tag '', '', false, :'ng-model' => 'contactQuery.contact_info_facebook' %><%= _('-- Any --') %><br/>
                      <%= radio_button_tag '', 'Yes', false, 'ng-model' => 'contactQuery.contact_info_facebook'  %><%= _('Yes') %><br/>
                      <%= radio_button_tag '', 'No', false, 'ng-model' => 'contactQuery.contact_info_facebook' %><%= _('No') %>
                    </label>
                  </div>
                </li>

                <li class="filter_set">
                  <label id="filter_church" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Church']);"><%= _('Church') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[church]', options_for_select([[_('-- Any --'), '']] + current_account_list.churches.select(&:present?)), multiple: true, size: 5, class: 'form-control', :'ng-model' => 'contactQuery.church' %>
                  </div>
                </li>

                <li class="filter_set">
                  <label id="filter_relatedTaskAction" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Related Task Action']);"><%= _('Related task action') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[activity_type]', options_for_select([[_('-- Any --'), ''], [_('-- None --'), 'null']] + (Task.new.assignable_activity_types & current_account_list.tasks.select(:activity_type).uniq.collect(&:activity_type)).collect { |a| [_(a), a] }, filters_params[:activity_type]), multiple: true, size: 5, class: 'form-control', :'ng-model' => 'contactQuery.relatedTaskAction' %>
                  </div>
                </li>
                <li class="filter_set">
                  <label id="filter_appeal" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Appeal']);"><%= _('Appeal') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[appeal]', options_from_collection_for_select(@appeals, 'id', 'name'), prompt: _('-- Any --'), multiple: true, size: 5, class: 'form-control', :'ng-model' => 'contactQuery.appeal' %>
                  </div>
                </li>
                <li class="filter_set">
                  <label id="filter_timezone" class="filter_title" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Timezone']);"><%= _('Timezone') %></label>
                  <div class="filter_set_inner">
                    <%= select_tag 'filters[timezone]', options_for_select([[_('-- Any --'), '']] + current_account_list.timezones.select(&:present?)), multiple: true, size: 5, class: 'form-control', :'ng-model' => 'contactQuery.timezone' %>
                  </div>
                </li>
                <li class="controls">
                  <a href="#" ng-click="mapContacts()" class="btn btn-default btn-xs" onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Map These Contacts']);"><i class="fa fa-map-marker"></i> <%= _('Map These Contacts') %></a>
                </li>
              </ul>
            </form>

          </li>
          <% if $rollout.active?(:insights, current_account_list) %>
            <li ng-class="{'selected': insightFilterIsActive()}">
              <span class="left_filters menu_item"><%= _('Insights') %></span>
              <p style="text-indent:40px">
                <a href="" ng-click="runInsight('recommendations')"
                   onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Increase Recommendations']);">
                  <%= _('Increase Recommendations') %>
                </a>
              </p>
            </li>
            <li class="controls" ng-show="insightFilterIsActive()">
              <a href="" ng-click="clearInsightFilter()" class="btn"><%= _('Clear Insight Filter') %></a>
            </li>
          <% end %>
          <a href="#" ng-click="resetFilters()" class="btn btn-primary btn-xs btn-block btn-filter-left ng-cloak"
             ng-hide="isEmptyFilter()"
             onClick="_gaq.push(['_trackEvent', 'Contacts Events', 'Filter', 'Reset Filters']);">
            <i class="fa fa-undo"></i> <%= _('Reset Filters') %>
          </a>
        </ul>
      </aside>
    </div>
    <div class="col-md-9 col-sm-12" ng-cloak>

      <div id="contentbody" class="withleft">
        <div class="sticky-page-filters" data-spy="affix" data-offset-top="182">
          <div class="page-filters">
            <div class="row">
              <div class="col-xs-2 col-sm-2 col-xs-3 hidden-md hidden-lg">
                <a class="btn btn-default btn-secondary toggle-mobile-filters"><i class="fa fa-bars"></i> Filters</a>
              </div>

              <div class="col-md-5 col-sm-5 col-xs-9 form-inline">
                <input autocomplete="off" class="search_filter ui-autocomplete-input form-control" id="contact_name" placeholder="<%= _('Filter by Name') %>" type="text" ng-model="contactQuery.name" size="40">
                <span ng-show="contactsLoading"><i class="fa fa-spinner fa-spin"></i></span>
              </div>
              <div class="col-md-5 col-md-offset-2 col-sm-5 col-xs-12 text-right">

                <div class="dropdown">
                  <%= link_to(_('Actions') + ' <span class="caret"></span>'.html_safe, "#",
                              class: "btn btn-default dropdown-toggle", id: "action-drop",
                              onclick: "_gaq.push(['_trackEvent', 'Contacts Events', 'Click', 'Bulk Actions']);",
                              type: "button", 'data-toggle' => "dropdown",
                              "aria-expanded" => "true", "data-disabled" => "true") %>
                  <%= render 'contacts_action_list' %>
                </div>

                <%= link_to(_('Merge'), '#', class: 'btn btn-default', data: {behavior: 'merge'}) %>
                <%= hidden_field_tag :selected_ids %>

                <%= link_to(_('Export'), '#', class: 'btn btn-default', data: {behavior: 'export'}) %>
                <span class="btn btn-default" data-toggle="tooltip" data-placement="top" title="<%= _('Select all') %>">
                  <input type="checkbox" class="checkall" /></span>

              </div>
            </div>
          </div>

          <div class="row page-controls">
            <div class="col-md-8 col-sm-8">
              <%= _('Showing') %> <b>{{page.from}}&nbsp;-&nbsp;{{page.to}}</b> <%= _('of') %> <b>{{totalContacts}}</b>
              <div class="pagination">
                <span class="previous_page disabled" ng-show="page.current === 1">
                  <i class="fa fa-chevron-left"></i> <%= _('Previous') %>
                </span>
                <a class="previous_page" rel="prev start" href="#" ng-click="page.current=page.current-1" ng-show="page.current > 1">
                  <i class="fa fa-chevron-left"></i> <%= _('Previous') %>
                </a>

                <span ng-repeat="n in [1, page.total] | makeRange">
                  <em class="current" ng-show="n === page.current">{{n}}</em>
                  <a rel="next" ng-show="n !== page.current && ((n > (page.current-8) && n < (page.current+8)) || n === 1 || n === page.total)" href="#" ng-click="page.current=n">{{n}}</a>
                  <span ng-show="(n === 2 && page.current > 9) || (n === page.total-1 && page.current < page.total - 8)">...</span>
                </span>

                <span class="next_page disabled" ng-show="page.current === page.total || page.total === 0">
                  <%= _('Next') %> <i class="fa fa-chevron-right"></i>
                </span>
                <a class="next_page" rel="next" href="#" ng-click="page.current=page.current+1" ng-show="page.current < page.total">
                  <%= _('Next') %> <i class="fa fa-chevron-right"></i>
                </a>
              </div>
            </div>
            <div class="col-md-4 col-sm-4 text-right form-inline">
              <%= _('Show') %>: <select ng-model="contactQuery.limit" ng-options="i as i for i in [25, 50, 100, 1000]" class="form-control"></select>
            </div>
          </div>
        </div>

        <div class="contacts-scrollable" id="contacts-scrollable" ng-cloak>
          <table class="tablelist" ng-class="{'contact_loading': contactsLoading}">
            <tr ng-show="contacts.length === 0 && contactQuery.viewPrefsLoaded">
              <td colspan="5">
                <p>
                  <% if current_account_list.contacts.any? %>
                    <strong><%= _('You have %{active_contacts} active contacts.').localize % { active_contacts: current_account_list.contacts.active.count } %></strong>
                    (<%= _('%{total_contacts} total contacts.').localize % {total_contacts: current_account_list.contacts.count} %>)
                    <%= _('Unfortunately none of them match your current search or filters.') %>
                  <% else %>
                    <%= _("Looks like you haven't added any contacts yet. You can add one or import some from another service.") %>
                  <% end %>
                </p>
                <p>
                  <% if current_account_list.contacts.any? %>
                    <a href="#" ng-click="resetFilters()" class="btn btn-primary"><%= _('Reset All Search Filters') %></a>
                  <% else %>
                    <%= link_to(_('Import Contacts'), "/accounts", class: 'btn btn-primary') %>
                  <% end %>
                  <%= link_to(_('Add New Contact'),'/contacts/new', class: 'btn btn-secondary') %>
                </p>
              </td>
            </tr>
            <tr contact="contact" ng-repeat="contact in contacts | orderBy:'name'" id="contact_{{contact.id}}" data-hook="contact"></tr>
          </table>
        </div>
      </div>

    </div>
  </div>
  <%= render 'tag_modals' %>
  <%= render 'task_modal' %>
  <%= render 'edit_modal' %>
  <%= render 'merge_modal' %>
  <%= render 'export_modal' %>
  <%= render 'contacts_map_modal' %>
