"<%==[
    'Contact Name', 'First Name', 'Last Name', 'Spouse First Name', 'Greeting', 'Envelope Greeting',
    'Mailing Street Address', 'Mailing City', 'Mailing State', 'Mailing Postal Code', 'Mailing Country', 'Status',
    'Commitment Amount', 'Commitment Frequency', 'Newsletter', 'Pledge Received', 'Tags',
    'Email 1', 'Email 2', 'Email 3', 'Email 4', 'Phone 1', 'Phone 2', 'Phone 3', 'Phone 4'
  ].map {|h| _(h)}.join('","') %>"
<%== CSV.generate do |csv|
  # Handles the assignments in contacts_controller#index and account_list#physical_newsletter_csv
  contacts ||= @contacts

  contacts.each do |contact|
    row = []
    row << contact.name
    row << contact.first_name
    row << contact.last_name
    row << contact.spouse_first_name
    row << contact.greeting
    row << contact.envelope_greeting
    row << (contact.mailing_address.street ? contact.mailing_address.street.gsub("\r\n", "  ") : nil)
    row << contact.mailing_address.city
    row << contact.mailing_address.state
    row << contact.mailing_address.postal_code
    row << contact.mailing_address.country
    row << contact.status
    row << contact.pledge_amount
    row << Contact.pledge_frequencies[contact.pledge_frequency || 1.0]
    row << contact.send_newsletter
    row << (contact.pledge_received ? 'Yes' : 'No')
    row << contact.tag_list

    email_addresses = contact.people.collect(&:email_addresses).flatten[0..3]
    email_row = 0
    email_addresses.each do |email|
      next if email.historic?
      row << email.email
      email_row += 1
    end
    (email_row..3).each do |i|
      row << ''
    end

    phone_numbers = contact.people.collect(&:phone_numbers).flatten[0..3]
    phone_numbers.each do |phone|
      row << phone.number
    end

    csv << row
  end
end %>
