<% @by_month = current_account_list.donations.where("donation_date >= ?", 12.months.ago.beginning_of_month).group_by {|r| r.donation_date.beginning_of_month}
   @by_month_index = 12.downto(0).collect {|i| i.months.ago.to_date.beginning_of_month}

   monthly_goal =  13.times.collect { current_account_list.monthly_goal }
   pledges = current_account_list.contacts.financial_partners.sum(&:monthly_pledge).to_i 
   monthly_average = (current_account_list.donations.where("donation_date >= ?", 12.months.ago.beginning_of_month).sum(:amount) / 13).to_i%>

<script type="text/javascript" charset="utf-8">
  var chart;
  $(document).ready(function() {
    chart = new Highcharts.Chart({
      chart: {
        renderTo: 'donations_summary_chart',
        height: 250
      },
      colors: [
        '#DB843D',
        '#4572A7',
        '#89A54E',
        '#AA4643',
        '#80699B',
        '#3D96AE',
        '#92A8CD',
        '#A47D7C',
        '#B5CA92'
      ],
      title: {
        text: ''
      },
      xAxis: {
        categories: [
        <%== 12.downto(0).collect {|i| l(i.months.ago.to_date, format: :month_abbrv).inspect}.join(",\n") %>
        ]
      },
      yAxis: {
        min: 0,
        title: {
          text: 'Amount (USD)'
        }
      },
      tooltip: {
        formatter: function() {
          return this.y;
        }
      },
      plotOptions: {
        column: {
          pointPadding: 0.2,
          borderWidth: 0
        }
      },
      series: [{
        name: '<%= _('Donations') %>',
        data: [<%= @by_month_index.collect {|month| @by_month[month] || []}.collect {|v| v.sum(&:amount)}.join(',') %>],
        type: 'column'
      },{
        name: '<%= _('Pledges') %>',
        data: [<%= 0.upto(12).collect { pledges }.join(',') %>],
        type: 'line'
      },{
        name: '<%= _('Monthly Goal') %>',
        data: [<%= 0.upto(12).collect { current_account_list.monthly_goal }.join(',') %>],
        type: 'line'
      },{
        name: '<%= _('Monthly Average') %>',
        data: [<%= 0.upto(12).collect { monthly_average }.join(',') %>],
        type: 'line'
      }]
    });
  });
</script>
